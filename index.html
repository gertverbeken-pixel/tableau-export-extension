<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Universal CSV Export + Tracker</title>
<!-- Tableau Extensions API -->
<script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
<style>
body { 
  font-family: sans-serif; 
  text-align: center; 
  padding: 2em; 
  background-color: #f8f9fa;
}
.container {
  background: white;
  padding: 2em;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-width: 400px;
  margin: 0 auto;
}
h2 {
  color: #007ac2;
  margin-bottom: 1em;
}
button {
  font-size: 1.1em;
  padding: 1em 2em;
  background-color: #007ac2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
  margin-top: 1em;
}
button:hover { 
  background-color: #005fa3; 
}
button:disabled { 
  background-color: #ccc; 
  cursor: not-allowed; 
}
.status { 
  margin: 1em 0; 
  font-style: italic; 
  color: #666; 
  padding: 0.5em;
  background-color: #f8f9fa;
  border-radius: 4px;
}
</style>
</head>
<body>
<div class="container">
  <h2>CSV Export + Tracker</h2>
  <div id="status" class="status">Initializing...</div>
  <button id="exportBtn" disabled>Export & Track</button>
</div>

<script>
console.log('CSV Export Tracker - Final Version loaded');

// Your Apps Script Web App URL
const EXPORT_BASE = 'https://script.google.com/macros/s/AKfycbwvedyTTLGIS74lSMqimw0h4GNqvr9mMlf8sHOj6uoqLRyPU38hQoT5wzvTDDwkK4FX/exec';

// Global variables
let dashboard = null;
let worksheets = [];

// Initialize the extension
async function initializeExtension() {
  try {
    await tableau.extensions.initializeAsync();
    
    dashboard = tableau.extensions.dashboardContent.dashboard;
    worksheets = dashboard.worksheets;
    
    document.getElementById('status').textContent = `Ready to export: ${dashboard.name}`;
    document.getElementById('exportBtn').disabled = false;
    
  } catch (err) {
    console.error('Initialization failed:', err);
    document.getElementById('status').textContent = 'Failed to initialize extension';
  }
}

// Export function
async function exportData() {
  try {
    document.getElementById('status').textContent = 'Preparing export...';
    
    // Get user and dashboard info
    let user = 'unknown';
    
    // Try multiple methods to get the username
    try {
      // Method 1: Extensions environment
      if (tableau.extensions.environment && tableau.extensions.environment.username) {
        user = tableau.extensions.environment.username;
        console.log('âœ… Got username from environment:', user);
      }
      // Method 2: User context (if available)
      else if (tableau.extensions.environment && tableau.extensions.environment.user) {
        user = tableau.extensions.environment.user.username || tableau.extensions.environment.user.name;
        console.log('âœ… Got username from user context:', user);
      }
      // Method 3: Try to get from dashboard context
      else if (dashboard && dashboard.user) {
        user = dashboard.user.username || dashboard.user.name;
        console.log('âœ… Got username from dashboard:', user);
      }
      else {
        console.warn('âš ï¸ Could not determine username automatically');
        
        // Fallback: Ask user to enter their username
        const promptedUser = prompt('For tracking purposes, please enter your username or email:');
        if (promptedUser && promptedUser.trim()) {
          user = promptedUser.trim();
          console.log('âœ… Got username from user prompt:', user);
        } else {
          console.warn('âš ï¸ User cancelled or entered empty username');
        }
      }
    } catch (userErr) {
      console.warn('âš ï¸ Error getting username:', userErr);
    }
    
    console.log('ðŸ” Final username for export:', user);
    
    const encodedUser = encodeURIComponent(user);
    const dashboardName = encodeURIComponent(dashboard.name);
    
    // Get applied filters for context
    let filters = [];
    if (worksheets.length > 0) {
      try {
        const worksheetFilters = await worksheets[0].getFiltersAsync();
        filters = worksheetFilters.map(filter => ({
          fieldName: filter.fieldName,
          filterType: filter.filterType,
          appliedValues: filter.appliedValues ? filter.appliedValues.map(v => v.value) : []
        }));
      } catch (filterErr) {
        console.warn('Could not get filters:', filterErr);
      }
    }
    
    // Build export URL
    const params = new URLSearchParams();
    params.append('searchName', dashboard.name);
    params.append('searchType', 'dashboard');
    params.append('user', encodedUser);
    params.append('dashboard', dashboardName);
    params.append('maxRows', '10000');
    params.append('includeAllColumns', 'true');
    params.append('universalMode', 'true');
    
    if (filters.length > 0) {
      params.append('filters', JSON.stringify(filters));
    }
    
    const url = `${EXPORT_BASE}?${params.toString()}`;
    
    document.getElementById('status').textContent = 'Opening export...';
    
    // Open export in new tab
    window.open(url, '_blank');
    
    // Reset status
    setTimeout(() => {
      document.getElementById('status').textContent = `Ready to export: ${dashboard.name}`;
    }, 2000);
    
  } catch (err) {
    console.error('Export failed:', err);
    document.getElementById('status').textContent = 'Export failed';
    alert('Export failed: ' + err.message);
  }
}

// Event listener
document.getElementById('exportBtn').addEventListener('click', exportData);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeExtension);
</script>
</body>
</html>