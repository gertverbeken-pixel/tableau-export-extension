<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Universal Multi-Format Export + Tracker</title>
<!-- Tableau Extensions API -->
<script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
<style>
body { font-family: sans-serif; text-align: center; padding: 2em; background-color: #f8f9fa; }
.container { background: white; padding: 2em; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
h2 { color: #007ac2; margin-bottom: 1em; }
button { font-size: 1.1em; padding: 1em 2em; background-color: #007ac2; color: white; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 1em; }
button:hover { background-color: #005fa3; }
button:disabled { background-color: #ccc; cursor: not-allowed; }
.status { margin: 1em 0; font-style: italic; color: #666; padding: 0.5em; background-color: #f8f9fa; border-radius: 4px; }
.format-selection { margin-bottom: 1.5em; text-align: left; }
.format-selection label { display: block; margin-bottom: 0.5em; font-weight: bold; color: #333; }
.format-selection select { width: 100%; padding: 0.8em; border: 2px solid #ddd; border-radius: 4px; font-size: 1em; background-color: white; color: #333; }
.format-selection select:focus { outline: none; border-color: #007ac2; }
</style>
</head>
<body>
<div class="container">
  <h2>Smart Export + Tracker</h2>
  <div class="format-selection">
    <label for="formatSelect">Export Format:</label>
    <select id="formatSelect">
      <option value="csv">CSV</option>
      <option value="excel">Excel (.xls)</option>
      <option value="pdf">PDF</option>
      <option value="json">JSON</option>
    </select>
  </div>
  <div id="status" class="status">Initializing...</div>
  <button id="exportBtn" disabled>Export & Track</button>
</div>

<script>
console.log('Universal Export Tracker - Version 3.0 loaded');

const EXPORT_URL = 'https://script.google.com/macros/s/AKfycbwvedyTTLGIS74lSMqimw0h4GNqvr9mMlf8sHOj6uoqLRyPU38hQoT5wzvTDDwkK4FX/exec';

let dashboard = null;

async function initializeExtension() {
  try {
    await tableau.extensions.initializeAsync();
    dashboard = tableau.extensions.dashboardContent.dashboard;
    document.getElementById('status').textContent = `Ready to export from: ${dashboard.name}`;
    document.getElementById('exportBtn').disabled = false;
  } catch (err) {
    console.error('Initialization failed:', err);
    document.getElementById('status').textContent = 'Error: Could not initialize';
  }
}

async function exportData() {
  const exportButton = document.getElementById('exportBtn');
  const statusDiv = document.getElementById('status');
  
  try {
    exportButton.disabled = true;
    const selectedFormat = document.getElementById('formatSelect').value;
    statusDiv.textContent = `Fetching data for ${selectedFormat.toUpperCase()} export...`;

    // Find the main data worksheet (heuristic: the one with the most columns)
    let targetWorksheet = null;
    let maxCols = 0;
    for (const ws of dashboard.worksheets) {
      const cols = await ws.getSummaryColumnsInfoAsync();
      if (cols.length > maxCols) {
        maxCols = cols.length;
        targetWorksheet = ws;
      }
    }

    if (!targetWorksheet) {
      throw new Error('Could not find a suitable worksheet to export.');
    }
    
    statusDiv.textContent = `Getting data from "${targetWorksheet.name}"...`;
    const dataTable = await targetWorksheet.getUnderlyingDataAsync({ includeAllColumns: true });
    
    const user = await findUsername();
    const csvData = convertDataTableToCSV(dataTable);

    statusDiv.textContent = 'Sending data to backend...';
    
    const response = await fetch(EXPORT_URL, {
      method: 'POST',
      mode: 'cors', // Required for cross-origin requests to Google Apps Script
      headers: {
        'Content-Type': 'text/plain;charset=utf-8', // Apps Script doPost needs text/plain
      },
      body: JSON.stringify({
        csvData: csvData,
        user: user,
        dashboard: dashboard.name,
        format: selectedFormat
      })
    });

    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Backend error: ${errorText}`);
    }
    
    statusDiv.textContent = 'Processing download...';
    
    // Handle the file download
    const blob = await response.blob();
    const formatExtensions = {
      csv: 'csv',
      excel: 'xls',
      pdf: 'pdf',
      json: 'json'
    };
    const extension = formatExtensions[selectedFormat] || 'dat';
    const filename = `${dashboard.name.replace(/\W+/g, '_')}_${new Date().toISOString().replace(/[:.]/g, '-')}.${extension}`;
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    statusDiv.textContent = `Export complete: ${dashboard.name}`;
    
  } catch (err) {
    console.error('Export failed:', err);
    statusDiv.textContent = `Error: ${err.message}`;
    alert(`Export failed: ${err.message}`);
  } finally {
    exportButton.disabled = false;
  }
}

async function findUsername() {
  // Try to get username from a dedicated worksheet first
  for (const ws of dashboard.worksheets) {
    const cols = await ws.getSummaryColumnsInfoAsync();
    if (cols.length === 1) {
      const data = await ws.getSummaryDataAsync({ maxRows: 1 });
      if (data.data.length === 1) {
        const potentialUser = data.data[0][0].value;
        if (typeof potentialUser === 'string' && potentialUser.trim() !== '' && potentialUser.trim() !== '%null%') {
          return potentialUser.trim();
        }
      }
    }
  }
  // Fallback to environment username
  return tableau.extensions.environment.username || 'unknown';
}

function convertDataTableToCSV(dataTable) {
  let csv = '';
  // Headers
  csv += dataTable.columns.map(col => `"${col.fieldName}"`).join(',') + '\r\n';
  // Rows
  for (const row of dataTable.data) {
    csv += row.map(cell => `"${cell.formattedValue}"`).join(',') + '\r\n';
  }
  return csv;
}

document.getElementById('exportBtn').addEventListener('click', exportData);
document.addEventListener('DOMContentLoaded', initializeExtension);
</script>
</body>
</html>
