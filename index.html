<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Full CSV Export + Tracker</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    button { font-size: 1.1em; padding: .8em 1.2em; }
  </style>
</head>
<body>
  <h2>Export Full CSV with Tracker</h2>
  <button id="exportBtn">Export & Track</button>
  <script>
    const webhookUrl = 'https://script.google.com/macros/s/AKfycbxrgR7BqnSoL01D-LzC_kBkqto579BRl9YBxJcYABhItWxvR-pbOCai6BJz2uCeewampw/exec';
    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        await tableau.extensions.initializeAsync();
        const dash = tableau.extensions.dashboardContent.dashboard;
        const ws   = dash.worksheets[0];
        const user = tableau.extensions.environment.username || 'unknown';
        const name = dash.name;
        const ts   = new Date().toISOString();

        const reader = await ws.getUnderlyingTableDataReaderAsync({ pageRowCount: 10000 });
        const cols = reader.getColumns().map(c => c.fieldName);
        const rows = [];
        while (reader.hasNext()) {
          const page = await reader.getNextPageAsync();
          rows.push(...page.data);
        }

        let csv = cols.map(c => \`"\${c}"\`).join(',') + '\n';
        rows.forEach(r => {
          csv += r.map(cell => \`"\${cell.formattedValue.replace(/"/g,'""')}"\`).join(',') + '\n';
        });
        csv += \`"TRACKER","\${user}","\${name}","\${ts}"\n\`;

        const blob = new Blob([csv], { type: 'text/csv' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = \`\${name.replace(/\s+/g,'_')}_\${ts}.csv\`;
        document.body.appendChild(link);
        link.click();
        link.remove();

        await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, dashboard: name, timestamp: ts })
        });

        console.log('✅ Full export, track & notify complete.');
      } catch (e) {
        console.error('❌ Export failed:', e);
        alert('Export failed: ' + e.message);
      }
    });
  </script>
</body>
</html>