<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Export Tracker</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    body { font-family:sans-serif; text-align:center; padding:2em; }
    button { font-size:1.1em; padding:.8em 1.2em; }
  </style>
</head>
<body>
  <h2>üì• Download Full Sheet (with Tracker)</h2>
  <button id="exportBtn">Export & Track</button>
  <script>
    const webhookUrl = "https://script.google.com/macros/s/AKfycbxrgR7BqnSoL01D-LzC_kBkqto579BRl9YBxJcYABhItWxvR-pbOCai6BJz2uCeewampw/exec";
    document.getElementById("exportBtn").addEventListener("click", async () => {
  try {
    await tableau.extensions.initializeAsync();
    const dash   = tableau.extensions.dashboardContent.dashboard;
    const ws     = dash.worksheets[0];  // or find by name
    const user   = tableau.extensions.environment.username || "unknown";
    const name   = dash.name;
    const ts     = new Date().toISOString();

    // 1) export all data as CSV (default)
    const fileObj = await ws.exportDataAsync({
      maxRows: 0,
      includeAllColumns: true
    });

    // 2) fetch it
    const resp = await fetch(fileObj.downloadUrl);
    let csv    = await resp.text();

    // 3) append your tracker row
    csv += `\n"TRACKER","${user}","${name}","${ts}"\n`;

    // 4) trigger download
    const blob = new Blob([csv], { type: "text/csv" });
    const a    = document.createElement("a");
    a.href     = URL.createObjectURL(blob);
    a.download = `${name.replace(/\s+/g,'_')}_${ts}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    // 5) notify backend
    await fetch(webhookUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ user, dashboard: name, timestamp: ts })
    });

    console.log("‚úÖ Export + track complete");
  }
  catch(err) {
    console.error("‚ùå Export failed:", err);
    alert("Export failed‚Äîcheck console.");
  }
});
  </script>
</body>
</html>