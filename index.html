<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Full CSV Export + Tracker</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    button { font-size: 1.1em; padding: .8em 1.2em; }
  </style>
</head>
<body>
  <h2>Export Full CSV with Tracker</h2>
  <button id="exportBtn">Export & Track</button>
  <script>
    const webhookUrl = 'https://script.google.com/macros/s/AKfycbxrgR7BqnSoL01D-LzC_kBkqto579BRl9YBxJcYABhItWxvR-pbOCai6BJz2uCeewampw/exec';

    document.getElementById('exportBtn').addEventListener('click', async () => {
      try {
        await tableau.extensions.initializeAsync();
        const dash = tableau.extensions.dashboardContent.dashboard;
        const ws   = dash.worksheets[0];  // or find by name
        const user = tableau.extensions.environment.username || 'unknown';
        const name = dash.name;
        const ts   = new Date().toISOString();

        // 1) Identify the logical table used by this worksheet
        const logicalTables = await ws.getUnderlyingTablesAsync();                      //  [oai_citation:0‡d45.github.io](https://d45.github.io/extensions-api/docs/trex_getdata.html)
        const tableId       = logicalTables[0].id;

        // 2) Create a paged reader (10k rows per page)
        const reader = await ws.getUnderlyingTableDataReaderAsync(tableId, {pageRowCount:10000});  //  [oai_citation:1‡d45.github.io](https://d45.github.io/extensions-api/docs/trex_getdata.html)

        // 3) Fetch every page into a single DataTable
        const dataTable = await reader.getAllPagesAsync();                               //  [oai_citation:2‡help.tableau.com](https://help.tableau.com/current/api/embedding_api/en-us/reference/interfaces/datatablereader.html?utm_source=chatgpt.com)
        await reader.releaseAsync();

        // 4) Extract columns & rows
        const cols = dataTable.columns.map(c => c.fieldName);
        const rows = dataTable.data;      // each row is an array of DataValue objects

        // 5) Build CSV text
        let csv = '"' + cols.join('","') + '"\n';
        rows.forEach(r => {
          const vals = r.map(cell => cell.formattedValue.replace(/"/g, '""'));
          csv += '"' + vals.join('","') + '"\n';
        });
        // 6) Append tracker row
        csv += `"TRACKER","${user}","${name}","${ts}"\n`;

        // 7) Trigger download
        const blob = new Blob([csv], { type: 'text/csv' });
        const a    = document.createElement('a');
        a.href     = URL.createObjectURL(blob);
        a.download = `${name.replace(/\s+/g,'_')}_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // 8) Notify backend
        await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user, dashboard: name, timestamp: ts })
        });

        console.log('✅ Full export, track & notify complete.');
      }
      catch (e) {
        console.error('❌ Export failed:', e);
        alert('Export failed: ' + e.message);
      }
    });
  </script>
</body>
</html>