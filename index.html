<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Full CSV Export + Tracker</title>
  <script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 2em; }
    button { font-size: 1.1em; padding: .8em 1.2em; }
  </style>
</head>
<body>
  <h2>Export Full CSV with Tracker</h2>
  <button id="exportBtn">Export & Track</button>
  <script>
    const webhookUrl = 'https://script.google.com/macros/s/AKfycbxrgR7BqnSoL01D-LzC_kBkqto579BRl9YBxJcYABhItWxvR-pbOCai6BJz2uCeewampw/exec';
    document.getElementById('exportBtn').addEventListener('click', async function() {
      try {
        await tableau.extensions.initializeAsync();
        var dash = tableau.extensions.dashboardContent.dashboard;
        var ws = dash.worksheets[0];
        var user = tableau.extensions.environment.username || 'unknown';
        var name = dash.name;
        var ts = new Date().toISOString();
        var reader = await ws.getUnderlyingTableDataReaderAsync({ pageRowCount: 10000 });
        var cols = reader.getColumns().map(function(c) { return c.fieldName; });
        var rows = [];
        while (reader.hasNext()) {
          var page = await reader.getNextPageAsync();
          rows = rows.concat(page.data);
        }
        // Build CSV header
        var csv = '"' + cols.join('","') + '"\n';
        // Build CSV rows
        rows.forEach(function(r) {
          var vals = r.map(function(cell) {
            return cell.formattedValue.replace(/"/g, '""');
          });
          csv += '"' + vals.join('","') + '"\n';
        });
        // Append tracker row
        csv += '"TRACKER","' + user + '","' + name + '","' + ts + '"\n';
        // Trigger download
        var blob = new Blob([csv], { type: 'text/csv' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = name.replace(/\s+/g, '_') + '_' + ts + '.csv';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        // Notify webhook
        await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: user, dashboard: name, timestamp: ts })
        });
        console.log('✅ Export, track & notify complete.');
      } catch (e) {
        console.error('❌ Export failed:', e);
        alert('Export failed: ' + e.message);
      }
    });
  </script>
</body>
</html>
