<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Universal Multi-Format Export + Tracker</title>
<!-- Tableau Extensions API -->
<script src="https://extensions.tableauusercontent.com/resources/tableau.extensions.1.latest.min.js"></script>
<style>
body { 
  font-family: sans-serif; 
  text-align: center; 
  padding: 2em; 
  background-color: #f8f9fa;
}
.container {
  background: white;
  padding: 2em;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  max-width: 400px;
  margin: 0 auto;
}
h2 {
  color: #007ac2;
  margin-bottom: 1em;
}
button {
  font-size: 1.1em;
  padding: 1em 2em;
  background-color: #007ac2;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
  margin-top: 1em;
}
button:hover { 
  background-color: #005fa3; 
}
button:disabled { 
  background-color: #ccc; 
  cursor: not-allowed; 
}
.status { 
  margin: 1em 0; 
  font-style: italic; 
  color: #666; 
  padding: 0.5em;
  background-color: #f8f9fa;
  border-radius: 4px;
}
.format-selection {
  margin-bottom: 1.5em;
  text-align: left;
}
.format-selection label {
  display: block;
  margin-bottom: 0.5em;
  font-weight: bold;
  color: #333;
}
.format-selection select {
  width: 100%;
  padding: 0.8em;
  border: 2px solid #ddd;
  border-radius: 4px;
  font-size: 1em;
  background-color: white;
  color: #333;
}
.format-selection select:focus {
  outline: none;
  border-color: #007ac2;
}
</style>
</head>
<body>
<div class="container">
  <h2>Smart Export + Tracker</h2>
  
  <div class="format-selection">
    <label for="formatSelect">Export Format:</label>
    <select id="formatSelect">
      <option value="csv">CSV</option>
      <option value="excel">Excel (.xlsx)</option>
      <option value="pdf">PDF</option>
      <option value="json">JSON</option>
    </select>
  </div>
  
  <div id="status" class="status">Initializing...</div>
  <button id="exportBtn" disabled>Export & Track</button>
</div>

<script>
console.log('Multi-Format Export Tracker - Version 2.4 loaded');

// Your Apps Script Web App URL
const EXPORT_BASE = 'https://script.google.com/macros/s/AKfycbwvedyTTLGIS74lSMqimw0h4GNqvr9mMlf8sHOj6uoqLRyPU38hQoT5wzvTDDwkK4FX/exec';

// Global variables
let dashboard = null;
let worksheets = [];

// Initialize the extension
async function initializeExtension() {
  try {
    await tableau.extensions.initializeAsync();
    
    dashboard = tableau.extensions.dashboardContent.dashboard;
    worksheets = dashboard.worksheets;
    
    document.getElementById('status').textContent = `Ready to export: ${dashboard.name}`;
    document.getElementById('exportBtn').disabled = false;
    
  } catch (err) {
    console.error('Initialization failed:', err);
    document.getElementById('status').textContent = 'Failed to initialize extension';
  }
}

// Export function
async function exportData() {
  try {
    // Get selected format
    const selectedFormat = document.getElementById('formatSelect').value;
    const formatNames = {
      'csv': 'CSV',
      'excel': 'Excel',
      'pdf': 'PDF',
      'json': 'JSON'
    };
    
    document.getElementById('status').textContent = `Preparing ${formatNames[selectedFormat]} export...`;
    
    // Get user and dashboard info with comprehensive detection
    let user = 'unknown';
    
    // Enhanced user detection with multiple methods
    try {
      console.log('ðŸ” Starting comprehensive user detection...');
      
      // Debug: Log all available environment properties
      if (tableau.extensions.environment) {
        console.log('ðŸ“Š Environment properties:', Object.keys(tableau.extensions.environment));
        console.log('ðŸ“Š Full environment object:', tableau.extensions.environment);
      }
      
      // Method 1: Direct environment username
      if (tableau.extensions.environment && tableau.extensions.environment.username) {
        user = tableau.extensions.environment.username;
        console.log('âœ… Method 1 - Got username from environment.username:', user);
      }
      
      // Method 2: Environment user object
      else if (tableau.extensions.environment && tableau.extensions.environment.user) {
        const userObj = tableau.extensions.environment.user;
        console.log('ðŸ“Š User object properties:', Object.keys(userObj));
        console.log('ðŸ“Š Full user object:', userObj);
        
        user = userObj.username || userObj.name || userObj.displayName || userObj.email || userObj.id;
        if (user) {
          console.log('âœ… Method 2 - Got username from environment.user:', user);
        }
      }
      
      // Method 3: Try to get user from workbook
      else if (dashboard && dashboard.workbook) {
        try {
          const workbook = dashboard.workbook;
          console.log('ðŸ“Š Workbook properties:', Object.keys(workbook));
          
          if (workbook.user) {
            const workbookUser = workbook.user;
            console.log('ðŸ“Š Workbook user properties:', Object.keys(workbookUser));
            user = workbookUser.username || workbookUser.name || workbookUser.displayName || workbookUser.email;
            if (user) {
              console.log('âœ… Method 3 - Got username from workbook.user:', user);
            }
          }
        } catch (workbookErr) {
          console.warn('âš ï¸ Could not access workbook user:', workbookErr);
        }
      }
      
      // Method 4: Try dashboard user (your original approach)
      else if (dashboard && dashboard.user) {
        const dashUser = dashboard.user;
        console.log('ðŸ“Š Dashboard user properties:', Object.keys(dashUser));
        user = dashUser.username || dashUser.name || dashUser.displayName || dashUser.email || dashUser.id;
        if (user) {
          console.log('âœ… Method 4 - Got username from dashboard.user:', user);
        }
      }
      
      // Method 5: Try to get from site context
      else {
        try {
          // Check if we can get site information
          if (tableau.extensions.environment && tableau.extensions.environment.site) {
            const site = tableau.extensions.environment.site;
            console.log('ðŸ“Š Site properties:', Object.keys(site));
            console.log('ðŸ“Š Site object:', site);
            
            if (site.user) {
              const siteUser = site.user;
              console.log('ðŸ“Š Site user properties:', Object.keys(siteUser));
              user = siteUser.username || siteUser.name || siteUser.displayName || siteUser.email;
              if (user) {
                console.log('âœ… Method 5 - Got username from site.user:', user);
              }
            }
          }
        } catch (siteErr) {
          console.warn('âš ï¸ Could not access site context:', siteErr);
        }
      }
      
      // Method 6: Try context parameter (sometimes passed by Tableau)
      if (user === 'unknown' && tableau.extensions.environment && tableau.extensions.environment.context) {
        try {
          const context = tableau.extensions.environment.context;
          console.log('ðŸ“Š Context properties:', Object.keys(context));
          
          if (context.user) {
            const contextUser = context.user;
            user = contextUser.username || contextUser.name || contextUser.displayName || contextUser.email;
            if (user) {
              console.log('âœ… Method 6 - Got username from context.user:', user);
            }
          }
        } catch (contextErr) {
          console.warn('âš ï¸ Could not access context:', contextErr);
        }
      }
      
      // Method 7: Try to get from browser/session context
      if (user === 'unknown') {
        try {
          // Method 7a: Check for user info in URL parameters or location
          const urlParams = new URLSearchParams(window.location.search);
          const urlUser = urlParams.get('user') || urlParams.get('username') || urlParams.get('email');
          if (urlUser) {
            user = urlUser;
            console.log('âœ… Method 7a - Got username from URL parameters:', user);
          }
          
          // Method 7b: Try to get from browser session/local storage
          else if (typeof Storage !== 'undefined') {
            const sessionUser = sessionStorage.getItem('tableau-user') || 
                               sessionStorage.getItem('user') || 
                               localStorage.getItem('tableau-user') ||
                               localStorage.getItem('user');
            if (sessionUser) {
              user = sessionUser;
              console.log('âœ… Method 7b - Got username from browser storage:', user);
            }
          }
          
          // Method 7c: Try to get from window/global context
          else if (window.tableau && window.tableau.user) {
            user = window.tableau.user.username || window.tableau.user.name || window.tableau.user.email;
            if (user) {
              console.log('âœ… Method 7c - Got username from window.tableau.user:', user);
            }
          }
          
        } catch (browserErr) {
          console.warn('âš ï¸ Browser context search failed:', browserErr);
        }
      }
      
      // Method 8: Deep object search (last resort before prompting)
      if (user === 'unknown') {
        try {
          // Sometimes user info is available in different locations
          const allProps = [];
          
          // Recursively search for user-like properties
          function findUserProps(obj, path = '') {
            if (obj && typeof obj === 'object') {
              Object.keys(obj).forEach(key => {
                const fullPath = path ? `${path}.${key}` : key;
                const value = obj[key];
                
                if (key.toLowerCase().includes('user') || 
                    key.toLowerCase().includes('name') || 
                    key.toLowerCase().includes('email')) {
                  allProps.push({ path: fullPath, key, value });
                  console.log(`ðŸ”Ž Found user-related property: ${fullPath} =`, value);
                }
                
                // Recursively search (but limit depth to avoid infinite loops)
                if (typeof value === 'object' && value !== null && path.split('.').length < 3) {
                  findUserProps(value, fullPath);
                }
              });
            }
          }
          
          // Search in all available tableau objects
          if (tableau.extensions) {
            findUserProps(tableau.extensions, 'tableau.extensions');
          }
          if (dashboard) {
            findUserProps(dashboard, 'dashboard');
          }
          
          // Also search window object for any tableau-related user info
          if (window.tableau) {
            findUserProps(window.tableau, 'window.tableau');
          }
          
          // Try to extract a username from found properties
          for (const prop of allProps) {
            if (prop.value && typeof prop.value === 'string' && 
                prop.value !== 'unknown' && prop.value.trim() !== '' &&
                !prop.value.toLowerCase().includes('null') &&
                !prop.value.toLowerCase().includes('undefined')) {
              user = prop.value.trim();
              console.log(`âœ… Method 8 - Found username from ${prop.path}:`, user);
              break;
            }
          }
          
        } catch (searchErr) {
          console.warn('âš ï¸ Deep search failed:', searchErr);
        }
      }
      
      // Final fallback: Prompt user only if still unknown
      if (user === 'unknown' || !user || user.trim() === '') {
        console.warn('âš ï¸ All automatic methods failed, prompting user');
        
        const promptedUser = prompt('For tracking purposes, please enter your username or email:');
        if (promptedUser && promptedUser.trim()) {
          user = promptedUser.trim();
          console.log('âœ… Got username from user prompt:', user);
        } else {
          console.warn('âš ï¸ User cancelled or entered empty username');
          user = 'anonymous-user';
        }
      }
      
    } catch (userErr) {
      console.error('âš ï¸ Error in user detection:', userErr);
      user = 'error-getting-user';
    }
    
    console.log('ðŸ” Final username for export:', user);
    
    const encodedUser = encodeURIComponent(user);
    const dashboardName = encodeURIComponent(dashboard.name);
    
    // Get applied filters for context and processing
    let filters = [];
    let filterSummary = 'No filters applied';
    
    if (worksheets.length > 0) {
      try {
        console.log('ðŸŽ›ï¸ Collecting filters from all worksheets...');
        
        // Collect filters from all worksheets
        const allFilters = [];
        for (const worksheet of worksheets) {
          try {
            const worksheetFilters = await worksheet.getFiltersAsync();
            worksheetFilters.forEach(filter => {
              allFilters.push({
                worksheet: worksheet.name,
                fieldName: filter.fieldName,
                filterType: filter.filterType,
                appliedValues: filter.appliedValues ? filter.appliedValues.map(v => v.value) : [],
                isAllSelected: filter.isAllSelected || false
              });
            });
            console.log(`ðŸ“‹ Found ${worksheetFilters.length} filters in worksheet: ${worksheet.name}`);
          } catch (wsFilterErr) {
            console.warn(`âš ï¸ Could not get filters from worksheet ${worksheet.name}:`, wsFilterErr);
          }
        }
        
        // Filter out empty or "all selected" filters
        filters = allFilters.filter(filter => 
          filter.appliedValues && 
          filter.appliedValues.length > 0 && 
          !filter.isAllSelected
        );
        
        console.log(`ðŸŽ¯ Found ${filters.length} active filters total`);
        
        // Create readable filter summary
        if (filters.length > 0) {
          const filterGroups = {};
          filters.forEach(filter => {
            const key = filter.fieldName;
            if (!filterGroups[key]) {
              filterGroups[key] = [];
            }
            filterGroups[key] = filterGroups[key].concat(filter.appliedValues);
          });
          
          const filterDescriptions = Object.keys(filterGroups).map(fieldName => {
            const values = [...new Set(filterGroups[fieldName])]; // Remove duplicates
            const cleanFieldName = fieldName.replace(/Current Edition/g, '').trim();
            
            if (values.length <= 3) {
              return `${cleanFieldName}: ${values.join(', ')}`;
            } else {
              return `${cleanFieldName}: ${values.slice(0, 3).join(', ')} (+${values.length - 3} more)`;
            }
          });
          
          filterSummary = filterDescriptions.join(' | ');
          console.log('ðŸ“ Filter summary:', filterSummary);
        }
        
      } catch (filterErr) {
        console.warn('âš ï¸ Error collecting filters:', filterErr);
      }
    }
    
    // Build export URL
    const params = new URLSearchParams();
    params.append('searchName', dashboard.name);
    params.append('searchType', 'dashboard');
    params.append('user', encodedUser);
    params.append('dashboard', dashboardName);
    params.append('maxRows', '10000');
    params.append('includeAllColumns', 'true');
    params.append('universalMode', 'true');
    params.append('format', selectedFormat); // Add selected format
    
    if (filters.length > 0) {
      params.append('filters', JSON.stringify(filters));
      params.append('filterSummary', filterSummary);
    }
    
    const url = `${EXPORT_BASE}?${params.toString()}`;
    
    document.getElementById('status').textContent = 'Opening export...';
    
    // Open export in new tab
    window.open(url, '_blank');
    
    // Reset status
    setTimeout(() => {
      document.getElementById('status').textContent = `Ready to export: ${dashboard.name}`;
    }, 2000);
    
  } catch (err) {
    console.error('Export failed:', err);
    document.getElementById('status').textContent = 'Export failed';
    alert('Export failed: ' + err.message);
  }
}

// Event listener
document.getElementById('exportBtn').addEventListener('click', exportData);

// Initialize when page loads
document.addEventListener('DOMContentLoaded', initializeExtension);
</script>
</body>
</html>
